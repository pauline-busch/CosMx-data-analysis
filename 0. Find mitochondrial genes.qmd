---
title: "QC and cut-off values"
author: "Pauline"
date: today
format: 
    html:
        self-contained: true
        toc: true
editor: source
editor_options: 
  chunk_output_type: console
---

## Load packages

```{r, warning=FALSE, message=FALSE}

library(readxl)
library(dplyr)

```

## Find mitochdrial genes 
From the Nanostring website - get the Gene information for [CosMxâ„¢ Human 6K Discovery Panel](https://nanostring.com/products/cosmx-spatial-molecular-imager/cosmx-rna-assays/human-6k-discovery-panel/). Genes that contain "mitichon" in their full name or full alias are recognized and will be used to annotate the Genes in our CosMx data. 

```{r, warning=FALSE, message=FALSE}

human6k_panel_info <- read_excel("./Info/Human_6k_Discovery_Gene_List.xlsx", sheet = 2)
human6k_panel_info$mito_gene_name <- grepl("mitochon", human6k_panel_info$`Gene Name(s)`)
human6k_panel_info$mito_alias <- grepl("mitochon", human6k_panel_info$`Alias(es)`)

human6k_mitochondrial <- human6k_panel_info %>% 
  filter(mito_gene_name | mito_alias) %>% 
  select(`Display Name`) %>% 
  pull()

```

## Get the gene expression matrix from CosMx data and annotate mitochondrial genes
```{r}

cos_path <- "C:/CosMx/Datasets/6k/TMA2" # Adjust file path if necessary
gene_matrix <- read.csv(file.path(cos_path, "TMA2_biomedx_MAR_6K_exprMat_file.csv"))

gene_matrix_mito <- gene_matrix %>%
  rename_with(~ paste0("MT_", .), .cols = which(colnames(gene_matrix) %in% human6k_mitochondrial))

```

To check if this worked we can look at one example gene. You will see below that from the information we got from Nanostring that we filtered "ABCB10" to be one of the mitochondrial genes. 
```{r}
human6k_mitochondrial[1:5]
```

Next we can have a look if this gene is in our data.
```{r}
tibble(gene_matrix[1,15:20])
```

Lastly we check if the gene name got annotated.
```{r}
tibble(gene_matrix_mito[1,15:20])
```

Seems like this worked! :)

## Save gene expression matrix
Save the version of the gene expression matrix that has mitochondrial genes marked with "MT_" in front of the gene name to later access this information.

```{r}
write.csv(gene_matrix_mito, file.path(cos_path, "TMA2_biomedx_MAR_6K_mito_exprMat_file.csv"))
```

